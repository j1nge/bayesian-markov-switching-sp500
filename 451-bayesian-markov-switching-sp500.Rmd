---
title: "451-bayesian-markov-switching-sp500"
  pdf_document: default
  html_document: default
---

```{r setup, message = FALSE, include = FALSE}
library(tidyverse)
library(lubridate) 
library(scales)
library(rstan)
```

```{r load-data}
spx_raw <- read_csv("SPX.csv")
glimpse(spx_raw)
head(spx_raw)
```

```{r compute_returns}
    spx <- spx_raw %>% mutate(
      Date = as.Date(Date),
      price = `Adj Close`,
      log_price = log(price),
      log_return = log_price - dplyr::lag(log_price)
    ) %>% 
    # drop the first row 
    filter(!is.na(log_return))
    sum(is.na(spx$log_return))
    glimpse(spx)
    summary(spx$log_return)
```
```{r plot-price, fig.height = 4.5}
    spx %>%
      ggplot(aes(x = Date, y = price)) + 
      geom_line() + 
      labs(
        title = "S&P 500 Price Over Time",
        x = "Date", 
        y = "Price (USD)"
      ) 
```

```{r hist-log-returns, fig.height = 4.5}
  spx %>% 
    ggplot(aes(x = log_return)) + 
    geom_histogram(bins = 60, linewidth = .2) + 
    labs(
      title = "Distribution of Daily Log Returns", 
      x = "Log return", 
      y = "Count"
    )
```
```{r plot-returns, fig.height=4.5}
spx %>%
  ggplot(aes(x = Date, y = log_return)) +
  geom_line(alpha = 0.7) +
  labs(
    title = "Daily Log Returns of the S&P 500",
    x = "Date",
    y = "Log return"
  )
```
This plot provides a macroscopic view of volatility clustering, a defining feature of financial return series and a key motivation for regime-based modeling. The most striking feature is the sustained period of extreme volatility during the 1930s, corresponding to the Great Depression. Similar, though shorter-lived, volatility spikes are visible during the 2008 financial crisis and the COVID-19 pandemic. Across the full sample, returns remain centered near zero, while the primary source of regime variation appears to be changes in volatility rather than shifts in average return. This motivates a regime-switching framework in which market states are characterized by distinct variance levels.

2008 Housing Crisis: 
```{r crisis-zoom, fig.height=4.5}
spx %>%
  filter(Date >= as.Date("2007-01-01"),
         Date <= as.Date("2009-12-31")) %>%
  ggplot(aes(x = Date, y = log_return)) +
  geom_line() +
  labs(
    title = "Daily Log Returns During the 2008 Financial Crisis",
    x = "Date",
    y = "Log return"
  )
```
This figure shows daily log returns of the S&P 500 during the 2008 housing crisis (2007-2009), encompassing the period of the global financial crisis. Several key features stand out.

First, prior to mid-2008, daily returns are relatively small and tightly clustered around zero. While there is some variability, most daily movements fall within a narrow range, consistent with a lower-volatility market environment.

Beginning in late 2008, return behavior changes sharply. The series exhibits frequent large-magnitude positive and negative returns, with several extreme observations. These large swings persist over an extended period rather than appearing as isolated shocks, indicating a sustained shift in market conditions rather than a single outlier event.

Notably, the mean of returns does not shift dramatically away from zero; instead, the dominant change is an increase in variability. This highlights volatility, rather than average return, as the primary driver distinguishing crisis periods from calm periods.

Similarily for the Great Depression: 

```{r crisis-zoom, fig.height=4.5}
spx %>%
  filter(Date >= as.Date("1927-01-01"),
         Date <= as.Date("1940-12-31")) %>%
  ggplot(aes(x = Date, y = log_return)) +
  geom_line() +
  labs(
    title = "Daily Log Returns During the Great Depression",
    x = "Date",
    y = "Log return"
  )
```

In our macro-plot, there's a notable feature in the late 1980s, corresponding to the largest market drop in this period. 

```{r biggest-crash, fig.height=4.5}
min_row <- spx %>%
  slice_min(log_return, n = 1)

min_row
crash_date <- min_row$Date
crash_date
start_date <- crash_date - 180
end_date   <- crash_date + 180

spx %>%
  filter(Date >= start_date, Date <= end_date) %>%
  ggplot(aes(x = Date, y = log_return)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  labs(
    title = "Daily Log Returns Around the Largest Market Drop",
    x = "Date",
    y = "Log return"
  )

```


This drop corresponds to Black Monday (October 19, 1987), when the U.S had the largest single-day percentage drop in the Dow Jones Industrial Average (roughly -22.6% in one day).  

```{r stan model}
# Prepare data for Stan
stan_data <- list(
  T = nrow(spx),
  y = spx$log_return
)

# Compile and run the Stan model
# Note: Save the Stan code above as "markov_switching.stan" in your working directory
fit <- stan(
  file = "markov_switching.stan",
  data = stan_data,
  iter = 2000,        # total iterations per chain
  warmup = 1000,      # warmup/burn-in iterations
  chains = 4,         # number of Markov chains
  cores = 4,          # use parallel processing
  seed = 123,         # for reproducibility
  control = list(adapt_delta = 0.95, max_treedepth = 12)
)

# Print model summary
print(fit, pars = c("mu", "sigma", "p11", "p22"))

# Extract posterior samples
posterior <- extract(fit)

# Check convergence diagnostics
library(bayesplot)
mcmc_trace(fit, pars = c("mu[1]", "mu[2]", "sigma[1]", "sigma[2]", "p11", "p22"))

# Summary statistics
cat("\n=== Regime Parameters ===\n")
cat("Regime 1 (Low Volatility):\n")
cat("  Mean:   ", mean(posterior$mu[,1]), "\n")
cat("  Sigma:  ", mean(posterior$sigma[,1]), "\n")
cat("\nRegime 2 (High Volatility):\n")
cat("  Mean:   ", mean(posterior$mu[,2]), "\n")
cat("  Sigma:  ", mean(posterior$sigma[,2]), "\n")

cat("\n=== Transition Probabilities ===\n")
cat("P(stay in regime 1): ", mean(posterior$p11), "\n")
cat("P(stay in regime 2): ", mean(posterior$p22), "\n")

# Expected duration in each regime
cat("\n=== Expected Durations ===\n")
cat("Expected days in regime 1: ", mean(1 / (1 - posterior$p11)), "\n")
cat("Expected days in regime 2: ", mean(1 / (1 - posterior$p22)), "\n")

# Extract most likely state sequence (averaged across posterior samples)
states_mat <- posterior$state
state_probs <- apply(states_mat, 2, function(x) mean(x == 2))

# Add regime probabilities to data
spx_regimes <- spx %>%
  mutate(
    regime_2_prob = state_probs,
    regime = ifelse(regime_2_prob > 0.5, 2, 1)
  )

# Plot returns colored by regime
ggplot(spx_regimes, aes(x = Date, y = log_return)) +
  geom_line(aes(color = factor(regime)), alpha = 0.6) +
  scale_color_manual(
    values = c("1" = "blue", "2" = "red"),
    labels = c("Low Volatility", "High Volatility")
  ) +
  labs(
    title = "S&P 500 Log Returns by Estimated Regime",
    x = "Date",
    y = "Log return",
    color = "Regime"
  ) +
  theme_minimal()

# Plot regime probability over time
ggplot(spx_regimes, aes(x = Date, y = regime_2_prob)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  labs(
    title = "Probability of High Volatility Regime Over Time",
    x = "Date",
    y = "P(High Volatility Regime)"
  ) +
  theme_minimal()

# Examine specific crisis periods with regime overlay
spx_regimes %>%
  filter(Date >= as.Date("2007-01-01"), Date <= as.Date("2009-12-31")) %>%
  ggplot(aes(x = Date, y = log_return)) +
  geom_line(aes(color = factor(regime)), alpha = 0.7) +
  scale_color_manual(
    values = c("1" = "blue", "2" = "red"),
    labels = c("Low Volatility", "High Volatility")
  ) +
  labs(
    title = "2008 Financial Crisis: Regime Classification",
    x = "Date",
    y = "Log return",
    color = "Regime"
  ) +
  theme_minimal()

# Summary table of time in each regime
regime_summary <- spx_regimes %>%
  group_by(regime) %>%
  summarise(
    days = n(),
    pct_time = n() / nrow(spx_regimes) * 100,
    mean_return = mean(log_return),
    sd_return = sd(log_return),
    min_return = min(log_return),
    max_return = max(log_return)
  )
print(regime_summary)
```

